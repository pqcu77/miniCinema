<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cinema.minicinema.Mapper.UserHistoryMapper">

    <resultMap id="UserHistoryResultMap" type="com.cinema.minicinema.entity.UserHistory">
        <id property="id" column="id" />
        <result property="userId" column="user_id" />
        <result property="movieId" column="movie_id" />
        <result property="viewTime" column="created_at" />
        <result property="watchDuration" column="watch_duration" />
        <result property="createdAt" column="created_at" />
    </resultMap>

    <!-- 1. 插入或更新用户行为 -->
    <insert id="upsert" parameterType="com.cinema.minicinema.entity.UserHistory">
        INSERT INTO user_history (
            user_id, movie_id, action, score, created_at
        ) VALUES (
                     #{userId}, #{movieId}, #{action}, #{score}, CURRENT_TIMESTAMP
                 )
        ON CONFLICT (user_id, movie_id, action)
            DO UPDATE SET
                          score = EXCLUDED.score,
                          created_at = CURRENT_TIMESTAMP
    </insert>

    <!-- 2. 根据用户、电影和动作查询 -->
    <select id="findByUserAndMovieAndAction" resultMap="UserHistoryResultMap">
        SELECT * FROM user_history
        WHERE user_id = #{userId}
          AND movie_id = #{movieId}
          AND action = #{action}
    </select>

    <!-- 3. 获取用户最近浏览的电影 -->
    <select id="getRecentViewedMovies" resultType="java.lang.Integer">
        SELECT movie_id FROM user_history
        WHERE user_id = #{userId}
          AND action = 'view'
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 4. 获取用户的行为记录 -->
    <select id="findByUserAndActions" resultMap="UserHistoryResultMap">
        SELECT * FROM user_history
        WHERE user_id = #{userId}
        AND action IN
        <foreach collection="actions" item="action" open="(" separator="," close=")">
            #{action}
        </foreach>
        ORDER BY created_at DESC
    </select>

    <!-- 5. 获取用户对电影的评分 -->
    <select id="getUserRating" resultType="java.math.BigDecimal">
        SELECT score FROM user_history
        WHERE user_id = #{userId}
          AND movie_id = #{movieId}
          AND action = 'rate'
    </select>

    <!-- 6. 统计用户对某部电影的行为 -->
    <select id="countUserAction" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM user_history
        WHERE user_id = #{userId}
          AND movie_id = #{movieId}
          AND action = #{action}
    </select>
</mapper>