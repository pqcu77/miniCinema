<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MiniCinema è¯Šæ–­å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; }
        .card {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .test-btn:active {
            transform: translateY(0);
        }
        .result {
            margin: 10px 0;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        #output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #333;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .stat-item {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #667eea;
        }
        .stat-label { font-size: 12px; color: #999; }
        .stat-value { font-size: 16px; font-weight: bold; color: #333; }
        .section { margin-bottom: 20px; }
        .loading { color: #ffc107; animation: blink 1s infinite; }
        @keyframes blink { 0%, 49%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ MiniCinema è¯Šæ–­å·¥å…· v2.0</h1>
            <p>ç”¨äºè¯Šæ–­å‰åç«¯è¿æ¥é—®é¢˜ï¼Œæ”¯æŒ localhost å’Œ ngrok æ¨¡å¼</p>
        </div>

        <div class="card">
            <h2>âš™ï¸ åç«¯ URL é…ç½®</h2>
            <div class="url-input-group">
                <input type="text" id="backendUrl" placeholder="è¾“å…¥åç«¯ URL">
                <button class="test-btn" onclick="saveBackendUrl()">ğŸ’¾ ä¿å­˜ URL</button>
                <button class="test-btn" onclick="useLocalhost()">ğŸ  æœ¬åœ° localhost</button>
                <button class="test-btn" onclick="useNgrok()">ğŸŒ ngrok ä»£ç†</button>
            </div>
            <div id="urlResult"></div>
            <div class="stats" id="stats"></div>
        </div>

        <div class="card">
            <h2>ğŸ” API è¿æ¥æµ‹è¯•</h2>
            <div class="button-group">
                <button class="test-btn" onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
                <button class="test-btn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
                <button class="test-btn" onclick="testMovieList()">æµ‹è¯•ç”µå½±åˆ—è¡¨</button>
                <button class="test-btn" onclick="testAllApis()">æ‰¹é‡æµ‹è¯•æ‰€æœ‰ API</button>
            </div>
            <div id="apiResult"></div>
        </div>

        <div class="card">
            <h2>ğŸ’¾ æœ¬åœ°å­˜å‚¨æ£€æŸ¥</h2>
            <button class="test-btn" onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
            <div id="storageResult"></div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h2>
            <button class="test-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="output"></div>
        </div>
    </div>

    <script>
        const OUTPUT = document.getElementById('output');
        let BACKEND_URL = localStorage.getItem('backendUrl') || 'http://localhost:8080';

        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            let prefix = '';
            switch(type) {
                case 'success': prefix = 'âœ…'; break;
                case 'error': prefix = 'âŒ'; break;
                case 'warning': prefix = 'âš ï¸'; break;
                case 'info': prefix = 'â„¹ï¸'; break;
            }
            const line = `[${timestamp}] ${prefix} ${msg}\n`;
            OUTPUT.textContent += line;
            OUTPUT.scrollTop = OUTPUT.scrollHeight;
            console.log(msg);
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            const userInfo = localStorage.getItem('userInfo');
            const token = localStorage.getItem('token');

            stats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">åç«¯ URL</div>
                    <div class="stat-value" title="${BACKEND_URL}">${BACKEND_URL.substring(0, 30)}...</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç™»å½•çŠ¶æ€</div>
                    <div class="stat-value">${userInfo ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Token</div>
                    <div class="stat-value">${token ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</div>
                </div>
            `;
        }

        function saveBackendUrl() {
            const url = document.getElementById('backendUrl').value.trim();
            if (!url) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ URL');
                return;
            }
            localStorage.setItem('backendUrl', url);
            BACKEND_URL = url;
            updateStats();
            const resultDiv = document.getElementById('urlResult');
            resultDiv.innerHTML = `<div class="result success">âœ… åç«¯ URL å·²ä¿å­˜: ${url}</div>`;
            log(`âœ… åç«¯ URL å·²æ›´æ–°ä¸º: ${url}`, 'success');
        }

        function useLocalhost() {
            document.getElementById('backendUrl').value = 'http://localhost:8080';
            saveBackendUrl();
        }

        function useNgrok() {
            const url = prompt('è¯·è¾“å…¥ ngrok æš´éœ²çš„ URL\nä¾‹å¦‚: https://abc123.ngrok.io');
            if (url) {
                document.getElementById('backendUrl').value = url;
                saveBackendUrl();
            }
        }

        async function testBackendConnection() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="result info"><span class="loading">ğŸ”„</span> æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...</div>';
            log(`ğŸ”Œ å¼€å§‹æµ‹è¯•åç«¯è¿æ¥: ${BACKEND_URL}`, 'info');

            try {
                const response = await fetch(`${BACKEND_URL}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'test', password: 'test123' })
                });

                log(`HTTP çŠ¶æ€ç : ${response.status} ${response.statusText}`, 'info');
                log(`å“åº”å¤´ Content-Type: ${response.headers.get('Content-Type')}`, 'info');

                const data = await response.json();
                log(`å“åº”å†…å®¹: ${JSON.stringify(data)}`, 'info');

                if (data.code === 1 || response.status === 200) {
                    resultDiv.innerHTML = '<div class="result success">âœ… åç«¯è¿æ¥æ­£å¸¸ï¼</div>';
                    log('âœ… åç«¯è¿æ¥æˆåŠŸ', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ åç«¯è¿æ¥å¤±è´¥: ${data.msg}</div>`;
                    log(`âŒ é”™è¯¯: ${data.msg}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                log(`   åç«¯ URL: ${BACKEND_URL}`, 'error');
                log(`   è¯·æ£€æŸ¥:', '
                    - åç«¯æ˜¯å¦è¿è¡Œåœ¨è¯¥ URL ä¸Š
                    - ngrok éš§é“æ˜¯å¦ä»ç„¶æ´»è·ƒ
                    - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸`, 'error');
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="result info"><span class="loading">ğŸ”„</span> æ­£åœ¨æµ‹è¯•ç™»å½•...</div>';
            log(`ğŸ” å¼€å§‹ç™»å½•æµ‹è¯•: ${BACKEND_URL}/user/login`, 'info');

            try {
                const response = await fetch(`${BACKEND_URL}/user/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: 'test', password: 'test123' })
                });

                const data = await response.json();
                log(`ç™»å½•å“åº”çŠ¶æ€: ${response.status}`, 'info');

                if (data.code === 1 && data.data) {
                    const userInfo = data.data;
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    localStorage.setItem('token', userInfo.token);
                    updateStats();

                    const html = `<div class="result success">
                        âœ… ç™»å½•æˆåŠŸï¼<br/>
                        ç”¨æˆ·ID: ${userInfo.userId}<br/>
                        ç”¨æˆ·å: ${userInfo.username}<br/>
                        Token: ${userInfo.token.substring(0, 20)}...<br/>
                        é‚®ç®±: ${userInfo.email || 'N/A'}
                    </div>`;
                    resultDiv.innerHTML = html;
                    log('âœ… ç™»å½•æˆåŠŸ', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ ç™»å½•å¤±è´¥: ${data.msg}</div>`;
                    log(`âŒ ç™»å½•å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ é”™è¯¯: ${error.message}</div>`;
                log(`âŒ ç™»å½•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testMovieList() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="result info"><span class="loading">ğŸ”„</span> æ­£åœ¨è·å–ç”µå½±åˆ—è¡¨...</div>';
            log(`ğŸ¬ å¼€å§‹è·å–ç”µå½±åˆ—è¡¨: ${BACKEND_URL}/movie/list`, 'info');

            try {
                const response = await fetch(`${BACKEND_URL}/movie/list?page=1&pageSize=5`);
                const data = await response.json();

                if (data.code === 1) {
                    const movies = data.data.records || [];
                    const html = `<div class="result success">
                        âœ… è·å–ç”µå½±åˆ—è¡¨æˆåŠŸï¼<br/>
                        å…± ${data.data.total} éƒ¨ç”µå½±<br/>
                        è·å–äº† ${movies.length} éƒ¨ç”µå½±
                    </div>`;
                    resultDiv.innerHTML = html;
                    log(`âœ… è·å–ç”µå½±åˆ—è¡¨æˆåŠŸï¼Œå…± ${data.data.total} éƒ¨ç”µå½±`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="result error">âŒ è·å–å¤±è´¥: ${data.msg}</div>`;
                    log(`âŒ è·å–å¤±è´¥: ${data.msg}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">âŒ é”™è¯¯: ${error.message}</div>`;
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testAllApis() {
            log('ğŸ”„ å¼€å§‹æ‰¹é‡æµ‹è¯•æ‰€æœ‰ API...', 'info');
            const apis = [
                { name: 'ç”µå½±åˆ—è¡¨', url: '/movie/list?page=1&pageSize=5' },
                { name: 'é¦–é¡µæ¨è', url: '/movie/recommend?limit=6' },
                { name: 'ç”¨æˆ·å†å²', url: '/movie/history?limit=10' }
            ];

            for (const api of apis) {
                try {
                    const response = await fetch(`${BACKEND_URL}${api.url}`);
                    const status = response.status === 200 ? 'âœ…' : 'âŒ';
                    log(`${status} ${api.name}: ${response.status}`, 'info');
                } catch (error) {
                    log(`âŒ ${api.name}: ${error.message}`, 'error');
                }
            }
            log('âœ… æ‰¹é‡æµ‹è¯•å®Œæˆ', 'success');
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('storageResult');
            log('ğŸ“¦ æ£€æŸ¥ localStorage...', 'info');

            const userInfo = localStorage.getItem('userInfo');
            const token = localStorage.getItem('token');
            const backendUrl = localStorage.getItem('backendUrl');

            let html = '<div class="result info">';

            if (userInfo) {
                const user = JSON.parse(userInfo);
                html += `âœ… userInfo å­˜åœ¨: ${user.username} (ID: ${user.userId})<br/>`;
                log(`âœ… userInfo: ${user.username}`, 'success');
            } else {
                html += `âŒ userInfo ä¸å­˜åœ¨<br/>`;
                log('âŒ userInfo æœªæ‰¾åˆ°', 'warning');
            }

            if (token) {
                html += `âœ… token å­˜åœ¨: ${token.substring(0, 20)}...<br/>`;
                log(`âœ… token: ${token.substring(0, 20)}...`, 'success');
            } else {
                html += `âŒ token ä¸å­˜åœ¨<br/>`;
                log('âŒ token æœªæ‰¾åˆ°', 'warning');
            }

            if (backendUrl) {
                html += `âœ… backendUrl: ${backendUrl}<br/>`;
                log(`âœ… backendUrl: ${backendUrl}`, 'success');
            }

            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function clearLogs() {
            OUTPUT.textContent = '';
            log('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            document.getElementById('backendUrl').value = BACKEND_URL;
            updateStats();
            log('ğŸš€ è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            log(`å½“å‰åç«¯ URL: ${BACKEND_URL}`, 'info');
            log('ğŸ’¡ æç¤º: å¦‚æœä½¿ç”¨ ngrokï¼Œè¯·ç‚¹å‡» "ngrok ä»£ç†" æŒ‰é’®é…ç½®', 'info');
        });

        // æŒ‰ Enter é”®ä¿å­˜ URL
        document.addEventListener('DOMContentLoaded', () => {
            const urlInput = document.getElementById('backendUrl');
            if (urlInput) {
                urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveBackendUrl();
                    }
                });
            }
        });
    </script>
</body>
</html>

