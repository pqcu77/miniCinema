<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½•çŠ¶æ€æµ‹è¯• - MiniCinema</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .test-container {
      max-width: 800px;
      margin: 100px auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    .test-section {
      margin: 2rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
    }
    .test-info {
      padding: 1rem;
      background: rgba(52, 152, 219, 0.1);
      border-left: 4px solid #3498db;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .test-success {
      padding: 1rem;
      background: rgba(46, 204, 113, 0.1);
      border-left: 4px solid #2ecc71;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .test-error {
      padding: 1rem;
      background: rgba(231, 76, 60, 0.1);
      border-left: 4px solid #e74c3c;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .btn-test {
      padding: 0.75rem 1.5rem;
      margin: 0.5rem;
      background: linear-gradient(45deg, #3498db, #2ecc71);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .btn-test:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }
    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 class="logo">ğŸ¬ MiniCinema</h1>
      <nav>
        <a href="index.html">é¦–é¡µ</a>
        <a href="movies.html">ç”µå½±</a>
      </nav>
      <div class="header-right">
        <a href="login.html">ç™»å½•</a>
        <a href="register.html">æ³¨å†Œ</a>
      </div>
    </div>
  </header>

  <div class="test-container">
    <h1 style="text-align: center; margin-bottom: 2rem;">ğŸ” å…¨å±€ç™»å½•çŠ¶æ€æµ‹è¯•</h1>

    <div class="test-section">
      <h2>å½“å‰ç™»å½•çŠ¶æ€</h2>
      <div id="loginStatus" class="test-info">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="test-section">
      <h2>ç”¨æˆ·ä¿¡æ¯</h2>
      <pre id="userInfo">åŠ è½½ä¸­...</pre>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯•æ“ä½œ</h2>
      <button class="btn-test" onclick="testLoginStatus()">ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
      <button class="btn-test" onclick="testGetUser()">ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯</button>
      <button class="btn-test" onclick="testGetToken()">ğŸ”‘ è·å– Token</button>
      <button class="btn-test" onclick="simulateLogin()">âœ… æ¨¡æ‹Ÿç™»å½•</button>
      <button class="btn-test" onclick="simulateLogout()">âŒ æ¨¡æ‹Ÿé€€å‡º</button>
    </div>

    <div class="test-section">
      <h2>äº‹ä»¶ç›‘å¬æµ‹è¯•</h2>
      <div id="eventLog" class="test-info">
        <strong>äº‹ä»¶æ—¥å¿—:</strong>
        <div id="eventMessages" style="margin-top: 0.5rem;"></div>
      </div>
      <button class="btn-test" onclick="clearEventLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="test-section">
      <h2>æµ‹è¯•è¯´æ˜</h2>
      <div class="test-info">
        <h3>å¦‚ä½•æµ‹è¯•ï¼š</h3>
        <ol>
          <li>ç‚¹å‡»"æ£€æŸ¥ç™»å½•çŠ¶æ€"æŸ¥çœ‹å½“å‰æ˜¯å¦å·²ç™»å½•</li>
          <li>å¦‚æœæœªç™»å½•ï¼Œå…ˆå» <a href="login.html">ç™»å½•é¡µé¢</a> ç™»å½•</li>
          <li>ç™»å½•åè¿”å›æ­¤é¡µé¢ï¼ŒçŠ¶æ€åº”è‡ªåŠ¨æ›´æ–°</li>
          <li>å°è¯•ç‚¹å‡»å…¶ä»–æŒ‰é’®æµ‹è¯•å„é¡¹åŠŸèƒ½</li>
          <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</li>
        </ol>
      </div>
    </div>
  </div>

  <script type="module">
    import userState from './js/userState.js';
    import eventBus from './js/eventBus.js';
    import { showMessage } from './js/utils.js';

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    document.addEventListener('DOMContentLoaded', () => {
      updateLoginStatus();
      setupEventListeners();
    });

    // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
    function updateLoginStatus() {
      const statusDiv = document.getElementById('loginStatus');
      const userInfoPre = document.getElementById('userInfo');

      if (userState.isLoggedIn()) {
        const user = userState.getUser();
        statusDiv.className = 'test-success';
        statusDiv.innerHTML = `
          <strong>âœ… å·²ç™»å½•</strong><br>
          ç”¨æˆ·å: ${user.username}<br>
          ç”¨æˆ·ID: ${user.userId}
        `;
        userInfoPre.textContent = JSON.stringify(user, null, 2);
      } else {
        statusDiv.className = 'test-error';
        statusDiv.innerHTML = '<strong>âŒ æœªç™»å½•</strong><br>è¯·å…ˆ <a href="login.html">ç™»å½•</a>';
        userInfoPre.textContent = 'æœªç™»å½•ï¼Œæ— ç”¨æˆ·ä¿¡æ¯';
      }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      eventBus.on('userLogin', (user) => {
        addEventLog('ğŸ‰ ç”¨æˆ·ç™»å½•äº‹ä»¶è§¦å‘', user);
        updateLoginStatus();
      });

      eventBus.on('userLogout', () => {
        addEventLog('ğŸ‘‹ ç”¨æˆ·é€€å‡ºäº‹ä»¶è§¦å‘', null);
        updateLoginStatus();
      });

      eventBus.on('userUpdated', (user) => {
        addEventLog('ğŸ”„ ç”¨æˆ·ä¿¡æ¯æ›´æ–°äº‹ä»¶è§¦å‘', user);
        updateLoginStatus();
      });
    }

    // æ·»åŠ äº‹ä»¶æ—¥å¿—
    function addEventLog(message, data) {
      const messagesDiv = document.getElementById('eventMessages');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.style.marginTop = '0.5rem';
      logEntry.style.padding = '0.5rem';
      logEntry.style.background = 'rgba(255, 255, 255, 0.05)';
      logEntry.style.borderRadius = '4px';
      logEntry.innerHTML = `
        <strong>${time}</strong> - ${message}
        ${data ? `<pre style="margin-top: 0.25rem;">${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      messagesDiv.insertBefore(logEntry, messagesDiv.firstChild);
    }

    // æµ‹è¯•å‡½æ•°
    window.testLoginStatus = () => {
      const isLoggedIn = userState.isLoggedIn();
      showMessage(
        `ç™»å½•çŠ¶æ€: ${isLoggedIn ? 'å·²ç™»å½• âœ…' : 'æœªç™»å½• âŒ'}`,
        isLoggedIn ? 'success' : 'error'
      );
      updateLoginStatus();
    };

    window.testGetUser = () => {
      const user = userState.getUser();
      if (user) {
        console.log('ç”¨æˆ·ä¿¡æ¯:', user);
        showMessage(`ç”¨æˆ·: ${user.username}`, 'success');
      } else {
        showMessage('æœªç™»å½•', 'error');
      }
    };

    window.testGetToken = () => {
      const token = userState.getToken();
      if (token) {
        console.log('Token:', token);
        showMessage('Token å·²è·å–ï¼ˆæŸ¥çœ‹æ§åˆ¶å°ï¼‰', 'success');
      } else {
        showMessage('æœªç™»å½•ï¼Œæ—  Token', 'error');
      }
    };

    window.simulateLogin = () => {
      // æ¨¡æ‹Ÿç™»å½•ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
      const mockUser = {
        userId: 999,
        username: 'æµ‹è¯•ç”¨æˆ·',
        email: 'test@test.com',
        token: 'mock-token-' + Date.now()
      };
      userState.setUser(mockUser);
      showMessage('æ¨¡æ‹Ÿç™»å½•æˆåŠŸï¼', 'success');
    };

    window.simulateLogout = () => {
      userState.clearUser();
      showMessage('å·²é€€å‡ºç™»å½•', 'success');
    };

    window.clearEventLog = () => {
      document.getElementById('eventMessages').innerHTML = '';
      showMessage('æ—¥å¿—å·²æ¸…é™¤', 'success');
    };
  </script>

  <script type="module" src="js/utils.js"></script>
</body>
</html>

