<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”µå½±è¯¦æƒ… - MiniCinema</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="header-left">
      <h1 onclick="window.location.href='index.html'">ğŸ¬ MiniCinema</h1>
    </div>
    <div class="header-right"></div>
  </header>

  <div class="container">
    <button onclick="history.back()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.7rem 1.5rem; border-radius: 25px; margin-bottom: 2rem; cursor: pointer; transition: all 0.3s ease;">â† è¿”å›</button>
    <div id="movieDetail" class="movie-detail"></div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    const movieId = new URLSearchParams(window.location.search).get('id');

    const loadMovieDetail = async () => {
      const container = document.getElementById('movieDetail');
      container.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨åŠ è½½ç”µå½±è¯¦æƒ…...</p></div>';

      try {
        const response = await api.getMovieDetail(movieId);

        if (response.code === 1) {
          const movie = response.data;
          const user = storage.getUser();

          container.innerHTML = `
            <div class="detail-poster">
              <img src="${movie.posterUrl || 'https://via.placeholder.com/300x450/1a1a2e/ffffff?text=ç”µå½±æµ·æŠ¥'}" alt="${movie.title}">
            </div>
            <div class="detail-info">
              <h2>${movie.title}</h2>
              <div class="detail-meta">
                <p><strong>å¯¼æ¼”ï¼š</strong> ${movie.director || 'æœªçŸ¥'}</p>
                <p><strong>ä¸»æ¼”ï¼š</strong> ${movie.actors || 'æœªçŸ¥'}</p>
                <p><strong>ç±»å‹ï¼š</strong> ${movie.genre || 'æœªçŸ¥'}</p>
                <p><strong>ä¸Šæ˜ æ—¥æœŸï¼š</strong> ${movie.releaseDate || 'æœªçŸ¥'}</p>
                <p><strong>æ—¶é•¿ï¼š</strong> ${movie.duration || '120'} åˆ†é’Ÿ</p>
                <p><strong>è¯„åˆ†ï¼š</strong> <span class="stars">â˜…â˜…â˜…â˜…â˜†</span> ${movie.rating || '8.5'}/10</p>
              </div>
              <div class="detail-description">
                <h3>å‰§æƒ…ä»‹ç»</h3>
                <p>${movie.description || 'è¿™æ˜¯ä¸€éƒ¨ç²¾å½©çš„ç”µå½±ä½œå“ï¼Œå€¼å¾—ä¸€çœ‹...'}</p>
              </div>
              <div class="btn-group">
                ${user ? `
                  <button class="btn" onclick="handleBuyTicket()">ğŸ« ç«‹å³è´­ç¥¨</button>
                  <button class="btn" onclick="handleToggleFavorite()" id="favoriteBtn" style="background: rgba(255,255,255,0.1);">â¤ï¸ æ”¶è—</button>
                ` : `
                  <button class="btn" onclick="window.location.href='login.html'">ğŸ” ç™»å½•è´­ç¥¨</button>
                `}
              </div>
            </div>
          `;

          if (user) {
            checkFavorite();
          }
        } else {
          container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">ç”µå½±è¯¦æƒ…åŠ è½½å¤±è´¥</p>';
        }
      } catch (error) {
        showMessage('åŠ è½½å¤±è´¥', 'error');
        container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>';
      }
    };

    const checkFavorite = async () => {
      const token = storage.getToken();
      const favorites = await api.getFavorites(token);
      const btn = document.getElementById('favoriteBtn');

      if (favorites.data?.some(fav => fav.movieId == movieId)) {
        btn.textContent = 'âœ“ å·²æ”¶è—';
        btn.dataset.isFavorite = 'true';
      }
    };

    const handleToggleFavorite = async () => {
      const token = storage.getToken();
      const btn = document.getElementById('favoriteBtn');

      if (btn.dataset.isFavorite === 'true') {
        await api.removeFavorite(token, movieId);
        btn.textContent = '+ æ”¶è—';
        btn.dataset.isFavorite = 'false';
      } else {
        await api.addFavorite(token, movieId);
        btn.textContent = 'âœ“ å·²æ”¶è—';
        btn.dataset.isFavorite = 'true';
      }
    };

    const handleBuyTicket = () => {
      showMessage('è´­ç¥¨åŠŸèƒ½å¼€å‘ä¸­...', 'success');
    };

    loadMovieDetail();
  </script>
</body>
</html>

